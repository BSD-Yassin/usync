name: Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  semantic-versioning:
    name: Semantic Versioning
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Get latest tag
      id: get_tag
      run: |
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "Latest tag: $LATEST_TAG"
    
    - name: Analyze commits and determine version bump
      id: version_bump
      run: |
        LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
        if [ "$LATEST_TAG" = "v0.0.0" ]; then
          COMMITS=$(git log --pretty=format:"%s" --no-merges)
        else
          COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s" --no-merges)
        fi
        
        echo "Commits since last tag:"
        echo "$COMMITS"
        
        BUMP_TYPE="patch"
        HAS_BREAKING=false
        HAS_FEAT=false
        
        while IFS= read -r commit; do
          if echo "$commit" | grep -qE "BREAKING CHANGE:|!:"; then
            HAS_BREAKING=true
          fi
          if echo "$commit" | grep -qE "^feat\(|^feat:"; then
            HAS_FEAT=true
          fi
        done <<< "$COMMITS"
        
        if [ "$HAS_BREAKING" = "true" ]; then
          BUMP_TYPE="major"
        elif [ "$HAS_FEAT" = "true" ]; then
          BUMP_TYPE="minor"
        fi
        
        echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
        echo "Bump type: $BUMP_TYPE"
    
    - name: Calculate new version
      id: new_version
      run: |
        LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
        BUMP_TYPE="${{ steps.version_bump.outputs.bump_type }}"
        
        VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
        IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
        
        case "$BUMP_TYPE" in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
        NEW_TAG="v${NEW_VERSION}"
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION"
    
    - name: Check if version bump is needed
      id: check_bump
      run: |
        LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
        NEW_TAG="${{ steps.new_version.outputs.new_tag }}"
        
        if [ "$LATEST_TAG" = "$NEW_TAG" ]; then
          echo "bump_needed=false" >> $GITHUB_OUTPUT
          echo "No version bump needed"
        else
          echo "bump_needed=true" >> $GITHUB_OUTPUT
          echo "Version bump needed: $LATEST_TAG -> $NEW_TAG"
        fi
    
    - name: Update Cargo.toml version
      if: steps.check_bump.outputs.bump_needed == 'true'
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i '' "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
        else
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
        fi
        echo "Updated Cargo.toml version to $NEW_VERSION"
    
    - name: Create version bump commit and PR
      if: steps.check_bump.outputs.bump_needed == 'true'
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
        git checkout -b version-bump-$NEW_VERSION
        git add Cargo.toml
        git commit -m "chore: Bump version to $NEW_VERSION"
        git push origin version-bump-$NEW_VERSION
    
    - name: Create Pull Request
      if: steps.check_bump.outputs.bump_needed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: version-bump-${{ steps.new_version.outputs.new_version }}
        title: "chore: Bump version to ${{ steps.new_version.outputs.new_version }}"
        body: |
          Automated version bump based on conventional commits.
          
          New version: **${{ steps.new_version.outputs.new_version }}**
          New tag: **${{ steps.new_version.outputs.new_tag }}**
          
          This PR will be auto-merged after approval.
        labels: |
          automated
          version-bump
        draft: false
    
    - name: Auto-approve and merge PR
      if: steps.check_bump.outputs.bump_needed == 'true'
      run: |
        sleep 5
        PR_NUMBER=$(gh pr list --head version-bump-${{ steps.new_version.outputs.new_version }} --json number -q '.[0].number')
        if [ -n "$PR_NUMBER" ]; then
          gh pr review $PR_NUMBER --approve
          gh pr merge $PR_NUMBER --squash --auto
          echo "PR #$PR_NUMBER approved and queued for merge"
        fi
    
    - name: Create and push tag after merge
      if: steps.check_bump.outputs.bump_needed == 'true'
      run: |
        sleep 10
        git fetch origin main
        git checkout main
        NEW_TAG="${{ steps.new_version.outputs.new_tag }}"
        git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
        git push origin "$NEW_TAG"
        echo "Created and pushed tag $NEW_TAG"

  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache Cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      run: cargo fmt --check
    
    - name: Run clippy
      run: cargo clippy -- -D warnings

  test:
    name: Test (${{ matrix.os }}, ${{ matrix.arch }})
    needs: [lint]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            target: x86_64-unknown-linux-gnu
            toolchain: stable
          - os: macos-latest
            arch: aarch64
            target: aarch64-apple-darwin
            toolchain: stable
          - os: ubuntu-latest
            arch: i686
            target: i686-unknown-linux-gnu
            toolchain: stable
            cross: true
          - os: ubuntu-latest
            arch: aarch64
            target: aarch64-unknown-linux-gnu
            toolchain: stable
            cross: true
          - os: ubuntu-latest
            arch: armv7
            target: armv7-unknown-linux-gnueabihf
            toolchain: stable
            cross: true
          - os: ubuntu-latest
            arch: arm
            target: arm-unknown-linux-gnueabihf
            toolchain: stable
            cross: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ matrix.toolchain }}
        targets: ${{ matrix.target }}
    
    - name: Install cross-compilation dependencies (Linux)
      if: runner.os == 'Linux' && matrix.cross == true
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static binfmt-support
        case "${{ matrix.target }}" in
          *-gnueabihf)
            sudo apt-get install -y gcc-arm-linux-gnueabihf
            ;;
          arm-unknown-linux-gnueabihf)
            sudo apt-get install -y gcc-arm-linux-gnueabihf
            ;;
          aarch64-*)
            sudo apt-get install -y gcc-aarch64-linux-gnu
            ;;
          i686-*)
            sudo apt-get install -y gcc-multilib
            ;;
        esac
    
    - name: Install cross (for cross-compilation)
      if: matrix.cross == true
      run: |
        cargo install cross --git https://github.com/cross-rs/cross
    
    - name: Cache Cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build (native)
      if: matrix.cross != true
      run: cargo build --release --target ${{ matrix.target }}
    
    - name: Build (cross-compiled)
      if: matrix.cross == true
      run: |
        if command -v cross &> /dev/null; then
          cross build --release --target ${{ matrix.target }}
        else
          cargo build --release --target ${{ matrix.target }}
        fi
    
    - name: Run unit tests (native)
      if: matrix.cross != true
      env:
        TARGET: ${{ matrix.target }}
        CARGO_BUILD_TARGET: ${{ matrix.target }}
      run: cargo test --target ${{ matrix.target }} --release
    
    - name: Run unit tests (cross-compiled)
      if: matrix.cross == true
      run: |
        echo "Skipping tests for cross-compiled target ${{ matrix.target }}"
    
    - name: Run integration tests (Linux/macOS)
      if: runner.os != 'Windows' && matrix.cross != true
      run: |
        chmod +x tests/test_runner.sh || true
        if [ "${{ runner.os }}" == "macOS" ]; then
          if [ -f "target/${{ matrix.target }}/release/usync" ]; then
            ./tests/test_runner.sh "target/${{ matrix.target }}/release/usync" || true
          elif [ -f "target/release/usync" ]; then
            ./tests/test_runner.sh "target/release/usync" || true
          fi
        else
          if [ -f "target/${{ matrix.target }}/release/usync" ]; then
            ./tests/test_runner.sh "target/${{ matrix.target }}/release/usync" || true
          elif [ -f "target/release/usync" ]; then
            ./tests/test_runner.sh "target/release/usync" || true
          fi
        fi

  security:
    name: Security
    needs: [test]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy
    
    - name: Run cargo audit
      uses: rustsec/audit-check@v1.4.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Run cargo clippy security lints
      run: |
        cargo clippy -- -D warnings -W clippy::suspicious -W clippy::security
    
    - name: Dependency Review
      if: github.event_name == 'pull_request'
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        deny-licenses: GPL-2.0, GPL-3.0

  build:
    name: Build Release
    needs: [security]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            target: x86_64-unknown-linux-gnu
            binary_name: usync
            toolchain: stable
          - os: macos-latest
            arch: aarch64
            target: aarch64-apple-darwin
            binary_name: usync
            toolchain: stable
          - os: ubuntu-latest
            arch: i686
            target: i686-unknown-linux-gnu
            binary_name: usync
            toolchain: stable
            cross: true
          - os: ubuntu-latest
            arch: aarch64
            target: aarch64-unknown-linux-gnu
            binary_name: usync
            toolchain: stable
            cross: true
          - os: ubuntu-latest
            arch: armv7
            target: armv7-unknown-linux-gnueabihf
            binary_name: usync
            toolchain: stable
            cross: true
          - os: ubuntu-latest
            arch: arm
            target: arm-unknown-linux-gnueabihf
            binary_name: usync
            toolchain: stable
            cross: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Determine version and channel
      id: version_info
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        VERSION=$(echo "$TAG_NAME" | sed 's/^v//')
        if echo "$TAG_NAME" | grep -qE "nightly|alpha|beta|rc"; then
          CHANNEL="nightly"
        else
          CHANNEL="stable"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
    
    - name: Update Cargo.toml version
      run: |
        VERSION="${{ steps.version_info.outputs.version }}"
        if [[ "$OSTYPE" == "darwin"* ]] || [[ "$RUNNER_OS" == "macOS" ]]; then
          sed -i '' "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
        else
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
        fi
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ matrix.toolchain }}
        targets: ${{ matrix.target }}
    
    - name: Install cross-compilation dependencies (Linux)
      if: runner.os == 'Linux' && matrix.cross == true
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static binfmt-support
        case "${{ matrix.target }}" in
          *-gnueabihf)
            sudo apt-get install -y gcc-arm-linux-gnueabihf
            ;;
          arm-unknown-linux-gnueabihf)
            sudo apt-get install -y gcc-arm-linux-gnueabihf
            ;;
          aarch64-*)
            sudo apt-get install -y gcc-aarch64-linux-gnu
            ;;
          i686-*)
            sudo apt-get install -y gcc-multilib
            ;;
        esac
    
    - name: Install cross (for cross-compilation)
      if: matrix.cross == true
      run: |
        cargo install cross --git https://github.com/cross-rs/cross
    
    - name: Cache Cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build release binary
      run: |
        if [ "${{ matrix.cross }}" = "true" ]; then
          if command -v cross &> /dev/null; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        else
          cargo build --release --target ${{ matrix.target }}
        fi
    
    - name: Find binary
      id: find_binary
      run: |
        BINARY_PATH=""
        if [ -f "target/${{ matrix.target }}/release/${{ matrix.binary_name }}" ]; then
          BINARY_PATH="target/${{ matrix.target }}/release/${{ matrix.binary_name }}"
        elif [ -f "target/release/${{ matrix.binary_name }}" ]; then
          BINARY_PATH="target/release/${{ matrix.binary_name }}"
        else
          echo "Binary not found!"
          exit 1
        fi
        
        echo "binary_path=$BINARY_PATH" >> $GITHUB_OUTPUT
    
    - name: Create release archive
      id: create_archive
      run: |
        VERSION="${{ steps.version_info.outputs.version }}"
        CHANNEL="${{ steps.version_info.outputs.channel }}"
        ARCHIVE_NAME="usync-${VERSION}-${CHANNEL}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz"
        
        mkdir -p release
        cp "${{ steps.find_binary.outputs.binary_path }}" release/usync
        chmod +x release/usync
        
        tar -czf "$ARCHIVE_NAME" -C release usync
        echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
    
    - name: Generate checksums
      run: |
        ARCHIVE_NAME="${{ steps.create_archive.outputs.archive_name }}"
        
        if command -v sha256sum &> /dev/null; then
          sha256sum "$ARCHIVE_NAME" > "${ARCHIVE_NAME}.sha256"
        elif command -v shasum &> /dev/null; then
          shasum -a 256 "$ARCHIVE_NAME" > "${ARCHIVE_NAME}.sha256"
        else
          echo "No checksum tool found!"
          exit 1
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: usync-${{ matrix.os }}-${{ matrix.arch }}
        path: |
          ${{ steps.create_archive.outputs.archive_name }}
          ${{ steps.create_archive.outputs.archive_name }}.sha256
        retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [build]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Determine version and channel
      id: version_info
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        VERSION=$(echo "$TAG_NAME" | sed 's/^v//')
        if echo "$TAG_NAME" | grep -qE "nightly|alpha|beta|rc"; then
          CHANNEL="nightly"
        else
          CHANNEL="stable"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
        find artifacts -name "*.sha256" -exec cp {} release-assets/ \;
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version_info.outputs.tag }}
        name: Release ${{ steps.version_info.outputs.tag }} (${{ steps.version_info.outputs.channel }})
        body: |
          ## Release ${{ steps.version_info.outputs.version }} (${{ steps.version_info.outputs.channel }})
          
          ### Downloads
          
          **Channel:** ${{ steps.version_info.outputs.channel }}
          
          **Checksums:** All archives include SHA256 checksum files.
          
          ### Installation
          
          ```bash
          # Extract and install
          tar -xzf usync-*.tar.gz
          sudo mv usync /usr/local/bin/
          ```
          
          ### Verify
          
          ```bash
          # Verify checksum
          sha256sum -c usync-*.tar.gz.sha256
          ```
        files: release-assets/*
        draft: false
        prerelease: ${{ steps.version_info.outputs.channel == 'nightly' }}

  summary:
    name: Pipeline Summary
    needs: [semantic-versioning, lint, test, security, build]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Check pipeline results
      run: |
        echo "## Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Semantic Versioning | ${{ needs.semantic-versioning.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.lint.result }}" != "success" ]; then
          echo "❌ Lint job failed"
          exit 1
        fi
        if [ "${{ needs.test.result }}" != "success" ]; then
          echo "❌ Test job failed"
          exit 1
        fi
        if [ "${{ needs.security.result }}" != "success" ]; then
          echo "❌ Security job failed"
          exit 1
        fi
        echo "✅ All pipeline jobs completed successfully!"

